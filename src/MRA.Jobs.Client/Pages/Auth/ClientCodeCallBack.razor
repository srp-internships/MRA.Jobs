@page "/ClientCodeCallBack"
@using System.Web
@using MRA.Identity.Application.Contract.User.Commands.GoogleAuth
@using System.Net
@using MRA.Identity.Application.Contract.User.Responses
@inject NavigationManager NavigationManager
@inject IdentityHttpClient Client
@inject ILocalStorageService LocalStorageService
@code {

    [Parameter]
    public string Code { get; set; }

    protected override async Task OnInitializedAsync()
    {

        var http = HttpUtility.ParseQueryString(WebUtility.UrlDecode(NavigationManager.Uri.Split('?')[1]));
        Console.WriteLine(NavigationManager.Uri);
        Console.WriteLine(http["code"]);
        Console.WriteLine(Code);

        var response = await Client.PostAsJsonAsync("auth/googleCode",new GoogleAuthCommand { Code = http["code"]! });//todo check code
        
        if (response.IsSuccessStatusCode)
        {
            await LocalStorageService.SetItemAsync("authToken", await response.Content.ReadFromJsonAsync<JwtTokenResponse>());
            NavigationManager.NavigateTo("");
        }
        else
        {
            NavigationManager.NavigateTo("error page");
        }
    }

}
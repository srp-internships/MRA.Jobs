@page "/ClientCodeCallBack"
@using System.Web
@using MRA.Identity.Application.Contract.User.Commands.GoogleAuth
@using System.Net
@using Microsoft.IdentityModel.Tokens
@using MRA.Identity.Application.Contract.User.Responses
@inject NavigationManager NavigationManager
@inject IdentityHttpClient Client
@inject ILocalStorageService LocalStorageService
@inject ISnackbar Snackbar

@code {

    protected override async Task OnInitializedAsync()
    {
        var http = HttpUtility.ParseQueryString(WebUtility.UrlDecode(NavigationManager.Uri.Split('?')[1]));

        var code = http["code"];
        if (code.IsNullOrEmpty())
        {
            Snackbar.Add("Google authorization failed. Please try again later.", Severity.Error);
            StateHasChanged();
            return;
        }
        var response = await Client.PostAsJsonAsync("auth/googleCode", new GoogleAuthCommand { Code = code, Application = "MraJobs", Role = "Applicant", });

        if (response.IsSuccessStatusCode)
        {
            await LocalStorageService.SetItemAsync("authToken", await response.Content.ReadFromJsonAsync<JwtTokenResponse>());
            NavigationManager.NavigateTo("");
        }
        else
        {
            NavigationManager.NavigateTo("error page");
        }
    }

}
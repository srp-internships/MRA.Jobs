@page "/dashboard/trainings"
@layout Dashboard
@using MRA.Jobs.Application.Contracts.TrainingVacancies.Responses;
@using MRA.Jobs.Client.Components.Dialogs;
@using MRA.Jobs.Application.Contracts.VacancyCategories.Responses;
@inject ITrainingService trainingService
@inject ICategoryService categoryService


<h3>TrainingVacancyPage</h3>


@if (categories == null)
{
    <div>loading....</div>
}
else
{
    <MudExpansionPanels>
        <MudExpansionPanel Text="Create new Job" @bind-IsExpanded="@panelOpenState">
            <MudTextField @bind-Value="@trainingService.createCommand.Title" Label="Title"></MudTextField>
            <MudTextField Lines="5" @bind-Value="@trainingService.createCommand.ShortDescription" Label="ShortDescription"></MudTextField>
            <MudTextField Lines="5" @bind-Value="@trainingService.createCommand.Description" Label="Description"></MudTextField>
            <MudTextField @bind-Value="@trainingService.createCommand.Duration" Label="Duration"></MudTextField>
            <MudTextField @bind-Value="@trainingService.createCommand.Fees" Label="Fees"></MudTextField>
            <MudSelect T="string" Label="Select category" @bind-Value="@selectedCategory">
                @foreach (var cat in categories)
                {
                    <MudSelectItem Value="@cat.Name"/>
                }
            </MudSelect>
            <MudTextField @bind-Value="trainingService.createCommand.EndDate" Format="MM/dd/yy H:mm:ss" Label="EndDate"></MudTextField>
            <MudTextField @bind-Value="trainingService.createCommand.PublishDate" Format="MM/dd/yy H:mm:ss" Label="PublishDate"></MudTextField>
            <MatButton Type="submit" @onclick="@HandleSubmit" Id="btnInsert" hidden="@isInserting">Create</MatButton>
            <MatButton Type="submit" @onclick="@HandleUpdate" Id="btnUpdate" hidden="@isUpdating">Update</MatButton>
            <MatButton Type="submit" @onclick="@HandleCancel" Id="btnUpdate">Cancel</MatButton>
        </MudExpansionPanel>
    </MudExpansionPanels>

    <DeleteConfirmation @bind-IsOpen="@isDialogOpen" OnConfirm="DeleteItem" />
    <MudTable Items="@trainings" Class="text-center" Breakpoint="Breakpoint.Md">
        <HeaderContent>
            <MudTh>Title</MudTh>
            <MudTh>Short description</MudTh>
            <MudTh>Category</MudTh>
            <MudTh>Publish date</MudTh>
            <MudTh>End date</MudTh>
            <MudTh>Duration</MudTh>
            <MudTh>Fees</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Title">@context.Title</MudTd>
            <MudTd DataLabel="Short description">@context.ShortDescription.Substring(0, 50) ...</MudTd>
            <MudTd DataLabel="Category">@context.Category</MudTd>
            <MudTd DataLabel="PublishDate">@context.PublishDate.ToString("D")</MudTd>
            <MudTd DataLabel="EndDate">@context.EndDate.ToString("D")</MudTd>
            <MudTd DataLabel="Duration">@context.Duration</MudTd>
            <MudTd DataLabel="Fees">@context.Fees</MudTd>
            <MudTd DataLabel="Action">
                <MudButton @onclick="()=>OnDeleteClick(context.Slug)" Style="color:#2094CC" Icon="delete">Delete</MudButton>
                <MudButton @onclick="()=>OnEditClick(context.Slug)" Style="color:#2094CC" Icon="edit">Edit</MudButton>
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>

   
}

@code {
    bool panelOpenState;
    bool isInserting;
    bool isUpdating = true;
    string UpdateSlug;
    string selectedCategory = string.Empty;

    private List<CategoryResponse> categories;
    private List<TrainingVacancyListDto> trainings;

    protected override async Task OnInitializedAsync()
    {

        await LoadData();
    }

    private bool isDialogOpen;
    private string itemSlugToDelete;

    void OnDeleteClick(string slug)
    {
        itemSlugToDelete = slug;
        isDialogOpen = true;
    }
    private async Task DeleteItem()
    {
        await trainingService.Delete(itemSlugToDelete);
        isDialogOpen = false;
        await LoadData();
    }

    private async Task OnEditClick(string slug)                     
    {
        var vacancy = await trainingService.GetBySlug(slug);
        if (vacancy != null)
        {
            trainingService.createCommand.Title = vacancy.Title;
            trainingService.createCommand.ShortDescription = vacancy.ShortDescription;
            trainingService.createCommand.Description = vacancy.Description;
            trainingService.createCommand.Duration = vacancy.Duration;
            trainingService.createCommand.EndDate = vacancy.EndDate;
            trainingService.createCommand.PublishDate = vacancy.PublishDate;
            trainingService.createCommand.CategoryId = vacancy.CategoryId;
            trainingService.createCommand.Fees = vacancy.Fees;
            isInserting = true;
            isUpdating = false;
            panelOpenState = true;
            UpdateSlug = slug;
        }
    }

    private async Task LoadData()
    {
        trainings = (await trainingService.GetAll()).Items;
        categories = await categoryService.GetAllCategory();
    }

    private async Task HandleSubmit()
    {
        await trainingService.Create();
        await LoadData();
        Clear();
    }

    private async Task HandleUpdate()
    {
        var catId = categories.FirstOrDefault(c => c.Name == selectedCategory).Id;
        trainingService.createCommand.CategoryId = catId;
        await trainingService.Update(UpdateSlug);
        await LoadData();
        Clear();
    }

    void HandleCancel()
    {
        Clear();
    }

    private void Clear()
    {
        trainingService.createCommand.Title = string.Empty;
        trainingService.createCommand.ShortDescription = string.Empty;
        trainingService.createCommand.Description = string.Empty;
        trainingService.createCommand.Fees = 0;
        trainingService.createCommand.Duration = 0;
        trainingService.createCommand.EndDate = DateTime.Now;
        trainingService.createCommand.PublishDate = DateTime.Now;
        isInserting = false;
        isUpdating = true;
        panelOpenState = false;
        UpdateSlug = string.Empty;
    }

}

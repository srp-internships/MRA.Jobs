@page "/jobs/apply/{Slug}"
@using MRA.Jobs.Application.Contracts.Applications.Commands.CreateApplication;
@using MRA.Jobs.Application.Contracts.JobVacancies.Responses;
@inject HttpClient httpClient
@inject IApplicationService ApplicationService;
@inject IVacancyService VacancyService
@inject NavigationManager NavigationManager
@using MRA.Jobs.Application.Contracts.VacancyClient;
@using MRA.Jobs.Client.Components.Vacancies

@if (serverError)
{
	<ServerErrorComponent />
}
else
{
	<VacancyApplication Slug="@Slug" application="@application" questionResponses="@questionResponses" taskResponses="@tasksResponses" vacancy="@job" />
}
@code {
	private bool serverError;
	private VacancyApplicationResponse job;
	private CreateApplicationCommand application;
	public Dictionary<string, string> questionResponses = new();
	public Dictionary<string, string> tasksResponses = new();

	[Parameter]
	public string Slug { get; set; }

	protected override async Task OnInitializedAsync()
	{
		try
		{
			var response = await VacancyService.GetBySlug(Slug);

			if (response != null)
			{
				job = new VacancyApplicationResponse
					{
						Id = response.Id,
						Title = response.Title,
						VacancyQuestions = response.VacancyQuestions,
						VacancyTasks = response.VacancyTasks
					};
				application = new CreateApplicationCommand
					{
						VacancyId = job.Id,
						VacancyResponses = job.VacancyQuestions.Select(q => new VacancyResponseDto
						{
							VacancyQuestion = new VacancyQuestionDto { Question = q.Question }
						}),
						TaskResponses = job.VacancyTasks.Select(t => new TaskResponseDto
						{
							TaskId = t.Id,
							Code = t.Template
						})
					};
				foreach (var question in job.VacancyQuestions)
				{
					questionResponses[question.Question] = "";
				}
				foreach (var task in job.VacancyTasks)
				{
					tasksResponses[task.Title] = task.Template;
				}
			}
		}
		catch (Exception)
		{
			serverError = true;
			StateHasChanged();
		}
	}
}
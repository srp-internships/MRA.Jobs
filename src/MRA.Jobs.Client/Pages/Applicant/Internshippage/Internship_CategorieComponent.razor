@using MRA.Jobs.Application.Contracts.Common;
@using MRA.Jobs.Application.Contracts.TrainingVacancies.Responses;
@using Blazorise;
@using Blazorise.Bootstrap;
@using Blazorise.Icons.FontAwesome;
@inject ITrainingService _trainingService;
@inject ICategoryService _categoryService;
@inject NavigationManager _manager;

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Styled Aside Component with Controllers</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
	
</head>
<body>
	<div class="container mt-5">
		<div class="row">
			<aside class="col-md-3">
				<section class="mb-4">
					<div>
						<h2>Categories</h2>
						@if (inAll)
						{
							<button class="selectedbtn rounded-2" @onclick="selectedAllCategories">
								all (@Count)
							</button>
						}
						else
						{
							<button class="categorybtn rounded-2" @onclick="selectedAllCategories">
								all @Count
							</button>
						}
						@if (!loading && Categories != null)
						{
							foreach (var category in Categories)
							{
								if (category.Selected)
								{
									<button class="selectedbtn rounded-2" @onclick="()=>CategoryButtonSelected(category.Category.Slug)">
										@category.Category.Name (@category.TrainingsCount)
									</button>
								}
								else
								{
									<button class="categorybtn rounded-2" @onclick="()=>CategoryButtonSelected(category.Category.Slug)">
										@category.Category.Name (@category.TrainingsCount)
									</button>
								}
							}
						}
						else
						{
							<h1>Loading...</h1>
						}
					</div>
				</section>
			</aside>
			<div class="col-md-9">
				<section>
					@if (DisplayedTrainings != null)
					{
						@foreach (var training in DisplayedTrainings)
						{
							<div class="vacancy-card" style="margin-bottom:20px">
								<div class="vacancy-card-header">
									<a href="/trainings/@training.Slug" class="vacancy-title">
										@training.Title
									</a>
								</div>
								<div class="vacancy-description">
									<p>
										@training.ShortDescription
									</p>
								</div>
							</div>
						}
					}
				</section>
			</div>
		</div>
	</div>
</body>
<div class="d-flex justify-content-center">
	@if (Trainings != null)
	{
		<Pagination>
			<PaginationItem Disabled=@(!Trainings.HasPreviousPage) @onclick="Previous">
				<PaginationLink>
					<span aria-hidden="true">«</span>
				</PaginationLink>
			</PaginationItem>
			@if (Trainings != null)
			{
				for (int i = 1; i <= Trainings.TotalPages; i++)
				{
					var pageNumberAsString = i.ToString();
					int currentPage = i;
					<PaginationItem @key="pageNumberAsString">
						<PaginationLink Page="@pageNumberAsString" Clicked="()=>SetActive(currentPage)">
							@pageNumberAsString
						</PaginationLink>
					</PaginationItem>
				}
			}
			<PaginationItem Disabled=@(!Trainings.HasNextPage) @onclick="Next">
				<PaginationLink>
					<span aria-hidden="true">»</span>
				</PaginationLink>
			</PaginationItem>
		</Pagination>
	}
</div>
@code {
	[Parameter]
	public string searchInput { get; set; }

	public List<TrainingCategoriesResponce> Categories { get; set; }

	public PagedList<TrainingVacancyListDto> Trainings { get; set; }
	public List<TrainingVacancyListDto> DisplayedTrainings { get; set; }

	bool loading = true;
	bool inAll = true;
	public int Count { get; set; }


	protected async override Task OnParametersSetAsync()
	{
		Categories = await _categoryService.GetTrainingCategoriesSinceCheckDate();
		if (searchInput == null)
		{
			Trainings = await _trainingService.GetAllSinceCheckDate();
			Console.Out.WriteLine($"{Trainings.PageSize}, {Trainings.TotalPages}");
			UpdateDisplayedTrainings();
			Count = Trainings.TotalCount;

			inAll = true;
		}
		else
		{
			GetSearchedTrainings();
		}
		loading = false;
	}


	private async void selectedAllCategories()
	{
		Trainings = await _trainingService.GetAllSinceCheckDate();
		UpdateDisplayedTrainings();
		Count = Trainings.TotalCount;

		foreach (var item in Categories)
		{
			item.Selected = false;
		}

		inAll = true;
		searchInput = null;

		StateHasChanged();
	}

	async void CategoryButtonSelected(string slug)
	{
		var category = Categories.FirstOrDefault(c => c.Category.Slug == slug);
		foreach (var item in Categories)
		{
			item.Selected = false;
		}

		Trainings = await _trainingService.GetByCategorySinceCheckDate(slug);
		UpdateDisplayedTrainings();

		category.Selected = true;
		inAll = false;
		searchInput = null;

		StateHasChanged();
	}


	async void GetSearchedTrainings()
	{
		Trainings = await _trainingService.SearchTrainingsSinceSearchDate(searchInput);
		UpdateDisplayedTrainings();
		StateHasChanged();
	}

	void UpdateDisplayedTrainings()
	{
		var startIndex = (Trainings.CurrentPageNumber - 1) * Trainings.PageSize;
		DisplayedTrainings = Trainings.Items.Skip(startIndex).Take(Trainings.PageSize).ToList();
	}


	private void Previous()
	{
		if (Trainings.HasPreviousPage)
		{
			Trainings.CurrentPageNumber--;
			UpdateDisplayedTrainings();
			if (Trainings.CurrentPageNumber == 1)
				Trainings.HasPreviousPage = false;
			Trainings.HasNextPage = true;
		}
	}

	private void Next()
	{
		if (Trainings.HasNextPage)
		{
			Trainings.CurrentPageNumber++;
			UpdateDisplayedTrainings();
			if (Trainings.CurrentPageNumber == Trainings.TotalPages)
				Trainings.HasNextPage = false;
			Trainings.HasPreviousPage = true;
		}
	}

	private void SetActive(int page)
	{
		Trainings.CurrentPageNumber = page;

		if (page != Trainings.TotalPages)
		{
			Trainings.HasNextPage = true;
		}
		else if (page == Trainings.TotalPages)
		{
			Trainings.HasNextPage = false;
		}

		if (page != 1)
		{
			Trainings.HasPreviousPage = true;
		}
		else if (page == 1)
		{
			Trainings.HasPreviousPage = false;
		}

		UpdateDisplayedTrainings();
	}
}

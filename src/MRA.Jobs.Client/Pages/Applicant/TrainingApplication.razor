@page "/trainings/apply/{Slug}"
@using MRA.Jobs.Application.Contracts.Applications.Commands.CreateApplication;
@using MRA.Jobs.Application.Contracts.VacancyClient;
@using MRA.Jobs.Client.Components.Vacancies
@inject ITrainingService TrainingService

@if (serverError)
{
    <ServerErrorComponent/>
}
else
{
    <VacancyApplication VacancyType="trainings" Slug="@Slug" Application="@application" QuestionResponses="@questionResponses" TaskResponses="@tasksResponses" Vacancy="@training"/>
}

@code {
    private bool serverError;
    private VacancyApplicationResponse training;
    private CreateApplicationCommand application;
    public Dictionary<string, string> questionResponses = new();
	public Dictionary<Guid, string> tasksResponses = new();

    [Parameter]
    public string Slug { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        try
        {
            var response = await TrainingService.GetBySlug(Slug);

            if (response != null)
            {
                training = new VacancyApplicationResponse
                {
                    Id = response.Id,
                    Title = response.Title,
                    VacancyTasks = response.VacancyTasks,
                    VacancyQuestions = response.VacancyQuestions,
                    Description = response.Description,
                    Duration = response.Duration,
                    Fees = response.Fees,
                    PublishDate = response.PublishDate,
                    EndDate = response.EndDate
                };
                application = new CreateApplicationCommand
                {
                    VacancySlug = Slug,
                    VacancyResponses = training.VacancyQuestions.Select(q => new VacancyResponseDto
                    {
                        VacancyQuestion = new VacancyQuestionDto { Question = q.Question }
                    }),
                    TaskResponses = training.VacancyTasks.Select(t => new TaskResponseDto
                    {
                        TaskId = t.Id,
                        Code = t.Template
                    })
                };

                foreach (var question in training.VacancyQuestions)
                {
                    questionResponses[question.Question] = "";
                }
                foreach (var task in training.VacancyTasks)
                {
                    tasksResponses[task.Id] = task.Template;
                }
            }
        }
        catch (Exception)
        {
            serverError = true;
            StateHasChanged();
        }
    }

}
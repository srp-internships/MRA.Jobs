@using MRA.Jobs.Client.Services
@using MRA.Jobs.Client.Enums
@using MRA.Jobs.Client.Components.Buttons
@using MRA.Jobs.Client.Components.Client
@using MudBlazor
@inherits LayoutComponentBase
@inject LayoutService LayoutService

<MudThemeProvider @ref="@_mudThemeProvider" Theme="@LayoutService.CurrentTheme" IsDarkMode="@LayoutService.IsDarkMode" IsDarkModeChanged="LayoutService.SetDarkMode"/>
<Header/>
<MudDialogProvider/>
<MudSnackbarProvider/>
<MudMainContent>
    <main id="main" style="min-height: 100vh">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge">
            @Body
        </MudContainer>
    </main>
</MudMainContent>

<MudText Style="text-align: center; padding-top: 3%">
    © 2023 Silk Road Professionals
</MudText>

<MudScrollToTop>
    <MudFab StartIcon="@Icons.Material.Filled.KeyboardArrowUp" Color="Color.Primary"/>
</MudScrollToTop>

<MudHidden Breakpoint="Breakpoint.MdAndUp">
    <div style="position: fixed; bottom: 76px; right: 16px; z-index: 999;">
        <MudMenu Variant="Variant.Text" AnchorOrigin="Origin.TopLeft" TransformOrigin="Origin.BottomRight"
                 PopoverClass="docs-layout-menu-shadow"
                 LockScroll="true">
            <ActivatorContent>
                <MudFab Color="Color.Tertiary" StartIcon="@Icons.Material.Filled.UploadFile" Label="CV"/>
            </ActivatorContent>
            <ChildContent>
                <NoVacancyUploadCV/>
            </ChildContent>
        </MudMenu>
    </div>
</MudHidden>

@code
{
    private MudThemeProvider _mudThemeProvider;

    protected override void OnInitialized()
    {
        LayoutService.MajorUpdateOccured += UpdateState;
    }

    private void UpdateState(object sender, EventArgs e)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        LayoutService.MajorUpdateOccured -= UpdateState;
    }

    private async Task ApplyUserPreferences()
    {
        var defaultDarkMode = await _mudThemeProvider.GetSystemPreference();
        await LayoutService.ApplyUserPreferences(defaultDarkMode);
    }

    private async Task OnSystemPreferenceChanged(bool newValue)
    {
        await LayoutService.OnSystemPreferenceChanged(newValue);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ApplyUserPreferences();
            await _mudThemeProvider.WatchSystemPreference(OnSystemPreferenceChanged);
            StateHasChanged();
        }
    }


}
@page "/resetPassword"
@inject IUserProfileService UserProfileService
@inject IAuthService AuthService
@inject ISnackbar Snackbar
@inject IContentService ContentService
@inject NavigationManager NavigationManager

<div class="container">
    <div class="row" style="margin-top:20px;">
        <div Class="d-flex align-center justify-center mud-width-full py-8">

            <MudGrid>
                <MudItem xs="1" sm="3"></MudItem>
                <MudItem xs="12" sm="6">
                    <h4>@ContentService["SignIn:LinkReset"]</h4>
                    @if (!codeSent)
                    {
                        <EditForm Model="phoneNumberQuery" OnInvalidSubmit="SendCode">
                            <FluentValidationValidator />
                            <MudCard>
                                <MudCardHeader></MudCardHeader>
                                <MudCardContent>
                                    <MudTextField Label="@ContentService["ResetPassword:PhoneNumber"]" @bind-Value="phoneNumberQuery.PhoneNumber" Variant="@Variant.Filled" Clearable
                                                   For="@(()=>phoneNumberQuery.PhoneNumber)" />
                                 </MudCardContent>
                                 <MudCardActions>
                                     <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit"
                                                OnClick="SendCode">
                                         @if (_processing)
                                        {
                                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                            <MudText Class="ms-2">@ContentService["VacancyApplication:Processing"]</MudText>
                                        }
                                        else
                                        {
                                            <MudText>@ContentService["ResetPassword:Sendconfirmationcode"]</MudText>
                                        }
                                    </MudButton>
                                </MudCardActions>
                            </MudCard>
                        </EditForm>
                    }

                    @if (codeSent && !codeConfirm)
                    {
                        <MudCard>
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <center>
                                        @* <MudText>UserName: <b>@userName</b></MudText> *@
                                    </center>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudTextField Label="@ContentService["SignUp:Code"]" @bind-Value="code" Variant="@Variant.Filled" Clearable />

                                 <br />
                                 <br />
                                 <MudCardActions>

                                     <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="ConfirmCode">
                                         @if (_processing)
                                        {
                                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                            <MudText Class="ms-2">@ContentService["VacancyApplication:Processing"]</MudText>
                                        }
                                        else
                                        {
                                            <MudText>@ContentService["SignUp:Apply"]</MudText>
                                        }
                                    </MudButton>
                                    <MudButton Variant="Variant.Text" Color="Color.Info" FullWidth="true" OnClick="SendCode" Disabled="@isResendDisabled">
                                        @if (_processing)
                                        {
                                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                            <MudText Class="ms-2">@ContentService["VacancyApplication:Processing"]</MudText>
                                        }
                                        else
                                        {
                                            <MudText>@ContentService["ResetPassword:Resendcode"]</MudText>
                                        }
                                    </MudButton>

                                </MudCardActions>
                                <div>
                                    <MudText Typo="Typo.body2" Color="Color.Default">@timeLeft @ContentService["SignUp:Secconds"].</MudText>

                                    </div>
                                </MudCardContent>


                            </MudCard>
                    }
                    @if (codeSent && codeConfirm)
                    {
                        <EditForm Model="model">
                            <FluentValidationValidator />
                            <MudCard>
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <center>
                                            @* 	<MudText>UserName: <b>@userName</b></MudText> *@
                                        </center>
                                    </CardHeaderContent>
                                </MudCardHeader>
                                <MudCardContent>
                                    <MudTextField @bind-Value="@model.Password" Label="@ContentService["ResetPassword:NewPassword"]" Variant="Variant.Outlined"
                                                  InputType="@PasswordInput" Adornment="Adornment.End" AdornmentIcon="@PasswordInputIcon"
                                                  OnAdornmentClick="ButtonTestclick" AdornmentAriaLabel="Show Password" For="@(()=>model.Password)" />
                                    <MudTextField @bind-Value="@model.ConfirmPassword" Label="@ContentService["SignUp:ConfirmPassword"]" Variant="Variant.Outlined"
                                                  InputType="@PasswordInput" Adornment="Adornment.End" AdornmentIcon="@PasswordInputIcon"
                                                  OnAdornmentClick="ButtonTestclick" AdornmentAriaLabel="Show Password" For="@(()=>model.ConfirmPassword)" />
                                </MudCardContent>
                                <MudCardActions>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled"
                                               ButtonType="ButtonType.Submit" OnClick="SubmitNewPassword">
                                        @if (_processing)
                                        {
                                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                            <MudText Class="ms-2">@ContentService["VacancyApplication:Processing"]</MudText>
                                        }
                                        else
                                        {
                                            <MudText> @ContentService["ResetPassword:Changepassword"]</MudText>
                                        }
                                    </MudButton>
                                </MudCardActions>
                            </MudCard>
                        </EditForm>
                    }
                </MudItem>
            </MudGrid>
        </div>
    </div>
</div>


@code {
    private bool _processing = false;
    private IsAvailableUserPhoneNumberQuery phoneNumberQuery = new IsAvailableUserPhoneNumberQuery();
    private ResetPasswordCommand model = new ResetPasswordCommand();
    private bool codeSent = false;
    private bool codeConfirm = false;
    private bool isResendDisabled = true;
    private int timeLeft = 60;
    private int? code;
    bool isShow;
    InputType PasswordInput = InputType.Password;
    string PasswordInputIcon = Icons.Material.Filled.VisibilityOff;

    void ButtonTestclick()
    {
        @if (isShow)
        {
            isShow = false;
            PasswordInputIcon = Icons.Material.Filled.VisibilityOff;
            PasswordInput = InputType.Password;
        }
        else
        {
            isShow = true;
            PasswordInputIcon = Icons.Material.Filled.Visibility;
            PasswordInput = InputType.Text;
        }
    }

    private async Task SendCode()
    {
        _processing = true;
        StateHasChanged();
        try
        {
            var isAvailable = await AuthService.IsAvailableUserPhoneNumber(phoneNumberQuery);
            if (isAvailable.IsSuccessStatusCode)
            {
                if ((await isAvailable.Content.ReadFromJsonAsync<bool>()))
                {
					Snackbar.Add(ContentService["Profile:Thisphonenumberisnotcorrect"],
                    Severity.Error);
                    return;
                }

            }

            bool response = await UserProfileService.SendConfirmationCode(phoneNumberQuery.PhoneNumber);
            if (response)
            {
                _processing = false;
                codeSent = true;
                isResendDisabled = true;
                timeLeft = 60;
                await StartCountdown();
            }
        }
        catch (Exception)
        {
            ServerNotResponding();
        }
        finally
        {
            _processing = false;
            StateHasChanged();
        }
    }

    private async Task ConfirmCode()
    {
        _processing = true;
        StateHasChanged();
        try
        {
            SmsVerificationCodeStatus response = await UserProfileService.CheckConfirmationCode(phoneNumberQuery.PhoneNumber, code);
            if (response == SmsVerificationCodeStatus.CodeVerifyFailure)
            {
				Snackbar.Add(ContentService["Profile:Codeisincorrector"], MudBlazor.Severity.Error);
            }
            else
            {
                _processing = false;
                codeConfirm = true;
            }
        }
        catch (Exception)
        {
            ServerNotResponding();
        }
        finally
        {
            _processing = false;
            StateHasChanged();
        }

    }

    private void ServerNotResponding()
    {
		Snackbar.Add(ContentService["Profile:Servernotrespondingtry"], MudBlazor.Severity.Error);
    }

    private async Task StartCountdown()
    {
        for (timeLeft = 60; timeLeft > 0; timeLeft--)
        {
            await Task.Delay(1000);
            StateHasChanged();
        }
        isResendDisabled = false;

    }



    private async Task SubmitNewPassword()
    {
        _processing = true;
        StateHasChanged();
        try
        {
            model.Code = code.HasValue ? code.Value : 0;
            model.PhoneNumber = phoneNumberQuery.PhoneNumber;
            var response = await AuthService.ResetPassword(model);

            if (!response.IsSuccessStatusCode)
            {
                Snackbar.Add((await response.Content.ReadFromJsonAsync<CustomProblemDetails>()).Detail);
                return;
            }

			Snackbar.Add(ContentService["Profile:Resetpasswordsuccessfully"], Severity.Success);
            NavigationManager.NavigateTo("login");
        }
        catch (Exception)
        {
            ServerNotResponding();
        }
        finally
        {
            _processing = false;
            StateHasChanged();
        }
    }
}